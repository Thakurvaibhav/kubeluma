<!DOCTYPE html><html><head><meta charset='utf-8'/><title>Kubeluma</title>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<style>
:root {
  --bg:#121417; --bg-alt:#1c1f24; --bg-alt2:#23272e; --panel:#181b20; --border:#2b3138;
  --text:#e6e9ed; --text-dim:#9aa3af; --accent:#3b82f6; --accent-glow:#60a5fa; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981;
  --font-stack: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  --radius:10px; --shadow:0 2px 4px -1px rgba(0,0,0,.4),0 4px 12px -2px rgba(0,0,0,.3);
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;}
body{font-family:var(--font-stack);background:var(--bg);color:var(--text);line-height:1.35;-webkit-font-smoothing:antialiased;}
header{background:linear-gradient(95deg,#14181d,#1c2229);padding:12px 20px;display:flex;flex-wrap:wrap;align-items:center;gap:18px;border-bottom:1px solid var(--border);} 
header strong{font-size:18px;letter-spacing:.5px;color:var(--accent);text-shadow:0 0 6px rgba(59,130,246,.4);} 
.badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:500;line-height:1;padding:4px 8px;border-radius:999px;background:var(--bg-alt2);color:var(--text-dim);border:1px solid var(--border);} 
.badge.phase-RUNNING{color:var(--ok);background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35);} 
.badge.phase-PENDING{color:var(--warn);background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);} 
.badge.phase-FAILED{color:var(--danger);background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);} 
.badge.phase-SUCCEEDED{color:var(--ok);background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35);} 
.badge.phase-UNKNOWN{color:var(--text-dim);} 
.badge.dep{background:rgba(59,130,246,.15);color:var(--accent);}

main{padding:18px;display:grid;gap:22px;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:var(--shadow);} 
.card h3{font-size:14px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-dim);} 
.small{font-size:11px;color:var(--text-dim);} 
.split{display:flex;flex-wrap:wrap;gap:10px;} 
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;width:100%;} 
.stat{background:var(--bg-alt2);border:1px solid var(--border);padding:8px 10px;border-radius:8px;display:flex;flex-direction:column;gap:4px;min-width:110px;}
.stat span.label{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);} 
.stat span.value{font-size:13px;font-weight:600;overflow-wrap:anywhere;word-break:break-word;}
#logs{white-space:pre;font-family:var(--mono);font-size:12px;background:#0b0d10;padding:10px;height:340px;overflow:auto;border:1px solid var(--border);border-radius:8px;line-height:1.25;} 
#logs::-webkit-scrollbar{width:10px;}#logs::-webkit-scrollbar-track{background:transparent;}#logs::-webkit-scrollbar-thumb{background:#2e343b;border-radius:6px;} 
.tbl{border-collapse:collapse;font-size:12px;width:100%;} 
.tbl th{font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);} 
.tbl td,.tbl th{border-bottom:1px solid var(--border);padding:5px 6px;text-align:left;} 
.tbl tbody tr:hover{background:rgba(255,255,255,.03);} 
select,button{background:var(--bg-alt2);color:var(--text);border:1px solid var(--border);border-radius:6px;font:inherit;font-size:12px;padding:5px 10px;cursor:pointer;} 
button:hover,select:hover{border-color:var(--accent);} 
button:active{transform:translateY(1px);}  
.chip{display:inline-block;padding:3px 8px;font-size:10px;border-radius:999px;background:var(--bg-alt2);border:1px solid var(--border);color:var(--text-dim);} 
.flex-col{display:flex;flex-direction:column;gap:12px;} 
.full{grid-column:1/-1;} 
.fade{color:var(--text-dim);}  
.link{color:var(--accent);text-decoration:none;} .link:hover{text-decoration:underline;} 
.focused-row{background:rgba(59,130,246,.15)!important;} 
.pointer{cursor:pointer;} 
.event-deployment{background:rgba(59,130,246,.08)!important;}
#patternOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:50;}
#patternBox{background:var(--panel);border:1px solid var(--border);padding:28px 32px;border-radius:14px;display:flex;flex-direction:column;gap:16px;min-width:360px;box-shadow:var(--shadow);}
#patternBox h2{margin:0;font-size:18px;letter-spacing:.5px;color:var(--accent);} 
#patternBox input{width:100%;padding:10px 12px;font-size:14px;border-radius:8px;border:1px solid var(--border);background:var(--bg-alt2);color:var(--text);} 
#patternBox input:focus{outline:1px solid var(--accent);} 
#patternError{color:var(--danger);font-size:12px;}
#patternActions{display:flex;gap:8px;margin-top:4px;}
#patternCurrent{font-size:11px;color:var(--text-dim);}

@media (max-width:780px){ main{grid-template-columns:1fr;} header{gap:10px;} }
</style></head><body>
<div id='patternOverlay' style='display:none'>
  <div id='patternBox'>
    <h2>Select Pods</h2>
    <div class='small'>Enter a regex to match pod names (e.g. ^api- or web-.*). Namespace is optional (CLI flag).</div>
    <input id='patternInput' placeholder='^api-' />
    <div id='patternActions'>
      <button id='patternSetBtn'>Search</button>
      <button id='patternCancelBtn' style='margin-left:auto;display:none;'>Cancel</button>
    </div>
    <div id='patternError'></div>
  </div>
</div>
<header>
  <strong>Kubeluma</strong>
  <span id='patternDisplay' class='badge' style='display:none'></span>
  <span id='podMatch' class='badge'></span>
  <span id='phase' class='badge'></span>
  <button id='changePatternBtn' style='display:none;'>New Search</button>
</header>
<main>
  <section class='card full' id='podsCard' style='display:none'>
    <h3>Pods</h3>
    <table class='tbl' id='podsTable'><thead><tr><th id='podsNameHeader' class='pointer'>Name <span id='podsNameSort'></span></th><th>Namespace</th><th>Phase</th><th>Ready</th><th>Restarts</th></tr></thead><tbody></tbody></table>
  </section>
  <section class='card' id='statusCard'>
    <h3>Status</h3>
    <div class='stat-grid' id='statusStats'></div>
  </section>
  <section class='card'>
    <h3>Containers</h3>
    <table class='tbl' id='containers'><thead><tr><th>Name</th><th>State</th><th>Restarts</th><th>Image</th></tr></thead><tbody></tbody></table>
  </section>
  <section class='card'>
    <h3>Metrics</h3>
    <table class='tbl' id='metrics'><thead><tr><th>Container</th><th>CPU (m)</th><th>Mem (MiB)</th></tr></thead><tbody></tbody></table>
    <div class='small' id='metricsNote'></div>
  </section>
  <section class='card full'>
    <h3>Events</h3>
    <table class='tbl' id='events'><thead><tr><th>Pod</th><th>Type</th><th>Reason</th><th>Message</th><th>Age</th></tr></thead><tbody></tbody></table>
  </section>
  <section class='card full'>
    <h3>Logs <span id='logsPod' class='badge' style='display:none'></span> <select id='containerSelect'></select> <button id='followBtn'>Pause</button></h3>
    <div id='logs'></div>
  </section>
  <section class='card full' id='envCard' style='display:none'>
    <h3>Environment Variables <select id='envContainerSelect'></select></h3>
    <table class='tbl' id='envTable'><thead><tr><th>Var</th><th>Value / Source</th></tr></thead><tbody></tbody></table>
  </section>
</main>
<script>
const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
let currentContainer=null, following=true, podName=null, podsList=[], focusPod=null, lastFocusPod=null, podSortAsc=true, patternSet=false, currentPattern=null;
// human-friendly age formatter
function formatAge(secs){ if(secs==null) return ''; if(secs<60) return secs+'s'; const m=Math.floor(secs/60); if(m<60) return m+'m'; const h=Math.floor(m/60); if(h<24) return h+'h'; const d=Math.floor(h/24); return d+'d'; }
ws.onopen=()=>{ ws.send(JSON.stringify({action:'subscribe',channel:'pod'})); };
ws.onmessage=(ev)=>{ const msg=JSON.parse(ev.data);
  if(msg.type==='awaitingPattern'){ if(!patternSet){ showPatternOverlay(); updatePatternDisplay(null);} }
  else if(msg.type==='pods'){ if(msg.data && msg.data.pattern){ currentPattern=msg.data.pattern; updatePatternDisplay(currentPattern);} hidePatternOverlay(); renderPods(msg.data); }
  else if(msg.type==='pod'){ hidePatternOverlay(); focusPod=msg.data.name; const changed=(focusPod!==lastFocusPod); lastFocusPod=focusPod; renderPod(msg.data); if(changed){ currentContainer=null; document.getElementById('logs').textContent=''; } if(!currentContainer){ const first=msg.data.containers[0]; if(first){ setContainer(first.name,true);} } }
  else if(msg.type==='event'){ appendEvent(msg.data);} else if(msg.type==='log'){ if(msg.container===currentContainer && msg.pod===podName) appendLog(msg.line);} else if(msg.type==='metrics'){ renderMetrics(msg.data);} };
function updatePatternDisplay(p){ const el=document.getElementById('patternDisplay'); const btn=document.getElementById('changePatternBtn'); if(p){ el.style.display='inline-flex'; el.textContent='/' + p + '/'; btn.style.display='inline-flex'; } else { el.style.display='none'; btn.style.display='none'; } }
function showPatternOverlay(){ document.getElementById('patternOverlay').style.display='flex'; document.getElementById('patternInput').focus(); document.getElementById('patternCancelBtn').style.display= patternSet ? 'inline-flex':'none'; }
function hidePatternOverlay(){ document.getElementById('patternOverlay').style.display='none'; }
async function setPattern(){ const val=document.getElementById('patternInput').value.trim(); if(!val){ document.getElementById('patternError').textContent='Pattern required'; return;} try{ const res= await fetch('/api/set_pattern',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pattern:val})}); const j=await res.json(); if(j.error){ document.getElementById('patternError').textContent=j.error; return;} patternSet=true; currentPattern=val; updatePatternDisplay(val); document.getElementById('patternError').textContent=''; hidePatternOverlay(); }catch(e){ document.getElementById('patternError').textContent='Request failed'; } }
async function resetPattern(){ try{ await fetch('/api/reset_pattern',{method:'POST'}); patternSet=false; currentPattern=null; updatePatternDisplay(null); showPatternOverlay(); document.getElementById('patternInput').value=''; }catch(e){ /* ignore */ } }
document.getElementById('patternSetBtn').onclick=setPattern; document.getElementById('patternInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ setPattern(); }}); document.getElementById('changePatternBtn').onclick=resetPattern; document.getElementById('patternCancelBtn').onclick=()=> hidePatternOverlay();
// initial overlay if no pattern baked in (server will emit awaitingPattern)
setTimeout(()=>{ if(!patternSet && podsList.length===0){ showPatternOverlay(); }},500);
function renderPods(payload){ podsList=(payload.pods||[]).slice().sort((a,b)=> podSortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name)); focusPod=payload.focus; const card=document.getElementById('podsCard'); card.style.display='flex'; const tbody=document.querySelector('#podsTable tbody'); tbody.innerHTML=''; podsList.forEach(p=>{ const tr=document.createElement('tr'); tr.className='pointer'+(p.name===focusPod?' focused-row':''); tr.onclick=()=>{ ws.send(JSON.stringify({action:'focus',pod:p.name})); }; const ready=p.ready+'/'+p.total; tr.innerHTML='<td>'+p.name+'</td><td>'+ (p.namespace||'') +'</td><td>'+p.phase+'</td><td>'+ready+'</td><td>'+p.restarts+'</td>'; tbody.appendChild(tr); }); const ind=document.getElementById('podsNameSort'); ind.textContent= podSortAsc ? '▲':'▼'; }
// attach header click once
(function(){ const h=document.getElementById('podsNameHeader'); if(h && !h._wired){ h._wired=true; h.onclick=()=>{ podSortAsc=!podSortAsc; renderPods({pods:podsList,focus:focusPod}); }; }})();
function renderPod(p){ window._lastPodObj=p; podName=p.name; document.getElementById('logsPod').style.display='inline-flex'; document.getElementById('logsPod').textContent=p.name; const phaseEl=document.getElementById('phase'); phaseEl.textContent=p.phase; phaseEl.className='badge phase-'+(p.phase||'UNKNOWN').toUpperCase(); const cbody=document.querySelector('#containers tbody'); cbody.innerHTML=''; let totalRestarts=0; p.containers.forEach(c=>{ totalRestarts+=c.restarts; const tr=document.createElement('tr'); tr.innerHTML='<td>'+c.name+'</td><td>'+c.state+'</td><td>'+c.restarts+'</td><td class="fade">'+c.image+'</td>'; cbody.appendChild(tr); }); const sel=document.getElementById('containerSelect'); const prev=sel.value; sel.innerHTML=''; p.containers.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; if(c.name===prev) o.selected=true; sel.appendChild(o); }); sel.onchange=()=> setContainer(sel.value); const envSel=document.getElementById('envContainerSelect'); const prevEnv=envSel.value; envSel.innerHTML=''; p.containers.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; if(c.name===prevEnv) o.selected=true; envSel.appendChild(o); }); envSel.onchange=()=> renderEnvForContainer(envSel.value, p); if(!prevEnv && p.containers.length){ envSel.value=p.containers[0].name; } renderEnvForContainer(envSel.value, p); const ready = p.containers.filter(c=>c.ready).length; const total = p.containers.length; const stats=[ ['Pod', p.name], ['Namespace', p.namespace], ['Phase', p.phase], ['Ready', `${ready}/${total}`], ['Total Restarts', totalRestarts], ['Node IP', p.node||'' ], ['Pod IP', p.podIP||'' ], ['Age', formatAge(p.ageSeconds) ] ]; const statsRoot=document.getElementById('statusStats'); statsRoot.innerHTML=''; stats.forEach(s=>{ const box=document.createElement('div'); box.className='stat'; box.innerHTML='<span class="label">'+s[0]+'</span><span class="value">'+s[1]+'</span>'; statsRoot.appendChild(box); }); document.querySelectorAll('#podsTable tbody tr').forEach(tr=>{ if(tr.firstChild && tr.firstChild.textContent===p.name){ tr.classList.add('focused-row'); } else { tr.classList.remove('focused-row'); }}); }
function renderEnvForContainer(containerName, pod){ const card=document.getElementById('envCard'); const tbody=document.querySelector('#envTable tbody'); tbody.innerHTML=''; if(!containerName){ card.style.display='none'; return; } const container=(pod.containers||[]).find(c=>c.name===containerName); if(!container){ card.style.display='none'; return; } card.style.display='flex'; (container.env||[]).forEach(ev=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+ev.name+'</td><td class="fade">'+(ev.value||'')+'</td>'; tbody.appendChild(tr); }); if((container.env||[]).length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="2" class="fade">No env vars</td>'; tbody.appendChild(tr); }}
function appendEvent(e){ const tbody=document.querySelector('#events tbody'); const tr=document.createElement('tr'); let typeClass=''; if(e.type==='Warning'){ typeClass='style="color:var(--warn);font-weight:600"'; } else if(e.type==='Error'){ typeClass='style="color:var(--danger);font-weight:600"'; } else if(e.type){ typeClass='style="color:var(--ok);font-weight:500"'; } const ageDisplay = formatAge(e.ageSeconds); tr.innerHTML='<td>'+e.pod+'</td><td '+typeClass+'>'+ (e.type || '') +'</td><td>'+ (e.reason||'') +'</td><td>'+ e.message +'</td><td>'+ageDisplay+'</td>'; tbody.prepend(tr); while(tbody.children.length>300) tbody.removeChild(tbody.lastChild); }
function appendLog(line){ const el=document.getElementById('logs'); el.append(line+'\n'); if(following) el.scrollTop=el.scrollHeight; }
function setContainer(name, force=false){ if(!podName) return; if(!force && name===currentContainer) return; currentContainer=name; ws.send(JSON.stringify({action:'subscribe',channel:'logs',pod:podName,container:name})); document.getElementById('logs').textContent=''; }
function renderMetrics(m){ if(m.disabled){ document.getElementById('metricsNote').textContent='Metrics not available'; return;} document.getElementById('metricsNote').textContent=''; const tbody=document.querySelector('#metrics tbody'); tbody.innerHTML=''; (m.containers||[]).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+c.name+'</td><td>'+c.cpu+'</td><td>'+c.memoryMiB+'</td>'; tbody.appendChild(tr); }); }
 document.getElementById('followBtn').onclick=()=>{ following=!following; document.getElementById('followBtn').textContent= following? 'Pause':'Resume'; };
</script></body></html>
